>今日把数据存进mysql
>

CREATE TABLE work_order_info (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
project_name VARCHAR(50) NOT NULL COMMENT '工单对应项目名称',
work_order_no VARCHAR(100) NOT NULL UNIQUE COMMENT '工单编号',
create_time DATE NOT NULL COMMENT '创建时间',
creator VARCHAR(20) NOT NULL COMMENT '创建人',
create_log VARCHAR(200) DEFAULT '' COMMENT '创建日志',
update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '工单基本信息表';



CREATE TABLE customer_demographic (
customer_id VARCHAR(32) PRIMARY KEY COMMENT '客户唯一标识（模拟UUID）',
predict_gender CHAR(1) COMMENT '预测性别（F-女，M-男）',
predict_age VARCHAR(20) COMMENT '预测年龄（不足18岁/18-24岁/25-29岁/30-34岁/35-39岁/40-49岁/大于50岁）',
province VARCHAR(50) COMMENT '预测地域-省份（如北京、贵州省）',
city VARCHAR(50) COMMENT '预测地域-城市（如贵阳市、铜仁市，海外/省级行政区可空）',
region_temperature VARCHAR(10) COMMENT '所在地区气温（小于15℃/大于15℃+）',
data_source VARCHAR(100) COMMENT '数据来源（预测年龄：买家最近1年淘宝行为；预测地域：最近180天淘宝收货地址）',
create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '数据创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '客户人口属性表';

CREATE TABLE customer_store_relation (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
customer_id VARCHAR(32) NOT NULL COMMENT '客户唯一标识（关联customer_demographic.customer_id）',
member_level VARCHAR(20) COMMENT '会员等级（未明确取值，如普通会员/银卡会员）',
platform_member_layer VARCHAR(20) COMMENT '平台会员分层（忠诚会员/沉默会员/高价值会员/潜力会员/活跃会员）',
points_expire VARCHAR(10) COMMENT '积分过期（小于15/大于15，单位未明确）',
collect_status VARCHAR(20) COMMENT '商品收藏状态（无收藏商品/有收藏商品）',
purchase_status VARCHAR(20) COMMENT '店铺购买状态（店铺无购买/店铺有购买）',
cart_status VARCHAR(20) COMMENT '购物车添加状态（店铺有加购/店铺无加购）',
store_visit_status VARCHAR(20) COMMENT '店铺访问状态（店铺无访问/店铺常逛）',
last_transaction_time DATETIME COMMENT '最近成功交易时间',
first_order_time DATETIME COMMENT '首次下单时间',
store_first_order_time DATETIME COMMENT '店铺首次下单时间',
payment_count INT COMMENT '付款次数（累计）',
successful_trans_count INT COMMENT '成功交易次数（累计）',
customer_unit_price DECIMAL(10,2) COMMENT '客单价（成功付款金额/成功交易次数）',
successful_payment_amt DECIMAL(10,2) COMMENT '成功付款金额（累计）',
avg_repurchase_cycle INT COMMENT '客户平均回购周期（天）',
high_potential_non_purchase TINYINT(1) COMMENT '高潜未购会员标识（1-是，0-否）',
has_purchased_goods TINYINT(1) COMMENT '购买商品标识（1-是：720天内购指定商品，0-否）',
create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '数据创建时间',
INDEX idx_customer_id (customer_id) COMMENT '客户ID索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '客户店铺关系表';


CREATE TABLE customer_all_network_attr (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
customer_id VARCHAR(32) NOT NULL COMMENT '客户唯一标识（关联customer_demographic.customer_id）',
sub_category_click_prefer VARCHAR(50) COMMENT '子类目点击偏好（如女装-连衣裙）',
leaf_category_search_prefer VARCHAR(50) COMMENT '叶子类目搜索偏好（如男装-牛仔裤-直筒）',
first_category_purchase_prefer VARCHAR(50) COMMENT '一级类目购买偏好（如食品/家电）',
first_category_collect_prefer VARCHAR(50) COMMENT '一级类目收藏偏好（如美妆/数码）',
first_category_cart_prefer VARCHAR(50) COMMENT '一级类目购物车偏好（如家居/运动）',
sub_leaf_category_purchase_prefer VARCHAR(50) COMMENT '子叶子类目购买偏好（如手机-智能手机-5G）',
first_category_search_prefer VARCHAR(50) COMMENT '一级类目搜索偏好（如服装/母婴）',
leaf_category_comprehensive_prefer VARCHAR(20) COMMENT '叶子类目网购综合偏好（高/中/低，基于近30天行为计算）',
like_live TINYINT(1) COMMENT '爱看直播标识（1-是：近30天看店播≥5天，0-否）',
like_content TINYINT(1) COMMENT '爱看内容标识（1-是，0-否）',
like_new_goods TINYINT(1) COMMENT '爱看新品标识（1-是，0-否）',
all_store_frequently_visit TINYINT(1) COMMENT '全网店铺常逛标识（1-是：近30天进店铺页≥15天，0-否）',
all_store_frequently_purchase TINYINT(1) COMMENT '全网店铺常买标识（1-是：近30天购≥5天，0-否）',
data_calc_basis VARCHAR(200) COMMENT '数据计算依据（近30天用户叶子类目行为：点击/搜索/收藏/加购/购买）',
create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '数据创建时间',
INDEX idx_customer_id (customer_id) COMMENT '客户ID索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '客户全网属性表';


CREATE TABLE customer_industry_attr (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
customer_id VARCHAR(32) NOT NULL COMMENT '客户唯一标识（关联customer_demographic.customer_id）',
industry_purchase_cycle VARCHAR(50) COMMENT '行业购买周期（近1年内行业有购买/近30天行业活跃/7天内行业活跃）',
member_industry_active TINYINT(1) COMMENT '会员行业活跃人群标识（1-是，0-否）',
other_industry_purchase TINYINT(1) COMMENT '其他行业购买标识（1-是：近1年内其他行业有购买，0-否）',
create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '数据创建时间',
INDEX idx_customer_id (customer_id) COMMENT '客户ID索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '客户行业属性表';


CREATE TABLE crowd_selection_config (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
selection_tag VARCHAR(50) NOT NULL COMMENT '圈选标签名称（如预测性别、预测年龄、爱看直播）',
tag_attr_status VARCHAR(20) DEFAULT '待设置' COMMENT '标签属性设置状态（待设置/已设置）',
labor_estimate VARCHAR(10) COMMENT '工时预估（3人日）',
config_remark VARCHAR(200) COMMENT '配置备注（如“预测地域需选择具体省份/城市”）',
create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '配置创建时间',
UNIQUE KEY uk_selection_tag (selection_tag) COMMENT '标签名称唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '人群圈选配置表';



CREATE TABLE data_operation_log (
id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
table_name VARCHAR(50) NOT NULL COMMENT '操作表名（如customer_demographic、work_order_info）',
operation_type VARCHAR(10) NOT NULL COMMENT '操作类型（INSERT-新增，UPDATE-更新）',
operation_content JSON COMMENT '操作内容（存储变更前后的字段值，如{"customer_id":"c001","before":{"predict_age":"18-24岁"},"after":{"predict_age":"25-29岁"}}）',
operator VARCHAR(20) DEFAULT 'system' COMMENT '操作人（system-系统模拟，user-人工）',
operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
operation_ip VARCHAR(20) DEFAULT '127.0.0.1' COMMENT '操作IP（模拟本地IP）',
log_remark VARCHAR(200) DEFAULT '' COMMENT '日志备注（如“模拟1000条客户数据新增”）'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '数据操作日志表';

-- 插入工单基础数据
INSERT INTO work_order_info (project_name, work_order_no, create_time, creator, create_log)
VALUES (
'用户画像',
'大数据-用户画像-07-客户主题客户分群',
'2025-01-23',
'郭洵',
'初始化工单数据，对应文档“1 基本信息”模块'
);

-- 插入日志
INSERT INTO data_operation_log (table_name, operation_type, operation_content, log_remark)
VALUES (
'work_order_info',
'INSERT',
'{"project_name":"用户画像","work_order_no":"大数据-用户画像-07-客户主题客户分群","create_time":"2025-01-23","creator":"郭洵"}',
'插入工单核心数据，工单编号与文档一致'
);


-- 创建存储过程生成1000条客户人口属性数据
DELIMITER //
CREATE PROCEDURE generate_customer_demographic(IN count INT)
BEGIN
DECLARE i INT DEFAULT 1;
DECLARE gender_arr CHAR(1)[] DEFAULT ['F', 'M']; -- 预测性别：女/男
DECLARE age_arr VARCHAR(20)[] DEFAULT ['不足18岁', '18-24岁', '25-29岁', '30-34岁', '35-39岁', '40-49岁', '大于50岁']; -- 工单定义年龄区间
DECLARE province_arr VARCHAR(50)[] DEFAULT ['北京', '贵州省', '广东省', '湖北省', '四川省', '浙江省', '上海市', '海外', '新疆维吾尔自治区', '安徽省']; -- 工单提及省份
DECLARE city_arr VARCHAR(50)[] DEFAULT ['贵阳市', '铜仁市', '遵义市', '安顺市', '毕节市', '六盘水市', '', '', '']; -- 贵州地市+空值（适配非贵州省份）
DECLARE temp_arr VARCHAR(10)[] DEFAULT ['小于15℃', '大于15℃+']; -- 气温区间
DECLARE customer_id VARCHAR(32);
DECLARE random_gender CHAR(1);
DECLARE random_age VARCHAR(20);
DECLARE random_province VARCHAR(50);
DECLARE random_city VARCHAR(50);
DECLARE random_temp VARCHAR(10);

    WHILE i <= count DO
        -- 生成随机属性值
        SET customer_id = CONCAT('c', LPAD(i, 4, '0')); -- 客户ID：c0001~c1000
        SET random_gender = gender_arr[FLOOR(1 + RAND() * 2)];
        SET random_age = age_arr[FLOOR(1 + RAND() * 7)];
        SET random_province = province_arr[FLOOR(1 + RAND() * 10)];
        -- 仅贵州省份分配具体地市，其他省份/海外为空
        IF random_province = '贵州省' THEN
            SET random_city = city_arr[FLOOR(1 + RAND() * 6)];
        ELSE
            SET random_city = '';
        END IF;
        SET random_temp = temp_arr[FLOOR(1 + RAND() * 2)];

        -- 插入客户数据
        INSERT INTO customer_demographic (
            customer_id, predict_gender, predict_age, province, city, region_temperature, data_source
        ) VALUES (
            customer_id,
            random_gender,
            random_age,
            random_province,
            random_city,
            random_temp,
            '预测年龄：买家最近1年淘宝行为；预测地域：最近180天淘宝收货地址'
        );

        -- 插入日志
        INSERT INTO data_operation_log (table_name, operation_type, operation_content, log_remark)
        VALUES (
            'customer_demographic',
            'INSERT',
            JSON_OBJECT(
                'customer_id', customer_id,
                'predict_gender', random_gender,
                'predict_age', random_age,
                'province', random_province,
                'city', random_city,
                'region_temperature', random_temp
            ),
            CONCAT('新增客户人口属性数据，客户ID：', customer_id)
        );

        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;

-- 调用存储过程生成1000条数据
CALL generate_customer_demographic(1000);


-- 创建存储过程生成1000条客户店铺关系数据
DELIMITER //
CREATE PROCEDURE generate_customer_store_relation(IN count INT)
BEGIN
DECLARE i INT DEFAULT 1;
DECLARE customer_id VARCHAR(32);
DECLARE member_level_arr VARCHAR(20)[] DEFAULT ['普通会员', '银卡会员', '金卡会员', '铂金会员'];
DECLARE member_layer_arr VARCHAR(20)[] DEFAULT ['忠诚会员', '沉默会员', '高价值会员', '潜力会员', '活跃会员'];
DECLARE points_expire_arr VARCHAR(10)[] DEFAULT ['小于15', '大于15'];
DECLARE status_arr VARCHAR(20)[] DEFAULT ['无收藏商品', '有收藏商品', '店铺无购买', '店铺有购买', '店铺有加购', '店铺无加购', '店铺无访问', '店铺常逛'];
DECLARE random_member_level VARCHAR(20);
DECLARE random_member_layer VARCHAR(20);
DECLARE random_points_expire VARCHAR(10);
DECLARE random_collect VARCHAR(20);
DECLARE random_purchase VARCHAR(20);
DECLARE random_cart VARCHAR(20);
DECLARE random_visit VARCHAR(20);
DECLARE random_payment_count INT;
DECLARE random_trans_count INT;
DECLARE random_unit_price DECIMAL(10,2);
DECLARE random_amt DECIMAL(10,2);
DECLARE random_cycle INT;
DECLARE random_high_potential TINYINT(1);
DECLARE random_has_purchased TINYINT(1);
DECLARE random_date DATETIME;

    WHILE i <= count DO
        SET customer_id = CONCAT('c', LPAD(i, 4, '0'));
        -- 生成随机属性值
        SET random_member_level = member_level_arr[FLOOR(1 + RAND() * 4)];
        SET random_member_layer = member_layer_arr[FLOOR(1 + RAND() * 5)];
        SET random_points_expire = points_expire_arr[FLOOR(1 + RAND() * 2)];
        SET random_collect = status_arr[FLOOR(1 + RAND() * 2)]; -- 仅收藏状态
        SET random_purchase = status_arr[FLOOR(3 + RAND() * 2)]; -- 仅购买状态
        SET random_cart = status_arr[FLOOR(5 + RAND() * 2)]; -- 仅加购状态
        SET random_visit = status_arr[FLOOR(7 + RAND() * 2)]; -- 仅访问状态
        SET random_payment_count = FLOOR(1 + RAND() * 50); -- 付款次数1~50
        SET random_trans_count = FLOOR(1 + RAND() * random_payment_count); -- 成功交易≤付款次数
        SET random_unit_price = FLOOR(10 + RAND() * 1000); -- 客单价10~1000元
        SET random_amt = random_trans_count * random_unit_price; -- 成功付款金额=交易次数*客单价
        SET random_cycle = FLOOR(7 + RAND() * 90); -- 回购周期7~90天
        SET random_high_potential = FLOOR(RAND() * 2); -- 高潜未购：0-否，1-是
        SET random_has_purchased = FLOOR(RAND() * 2); -- 购买商品：0-否，1-是
        SET random_date = DATE_SUB(NOW(), INTERVAL FLOOR(1 + RAND() * 720) DAY); -- 时间：近720天内

        -- 插入数据
        INSERT INTO customer_store_relation (
            customer_id, member_level, platform_member_layer, points_expire, collect_status,
            purchase_status, cart_status, store_visit_status, last_transaction_time,
            first_order_time, store_first_order_time, payment_count, successful_trans_count,
            customer_unit_price, successful_payment_amt, avg_repurchase_cycle,
            high_potential_non_purchase, has_purchased_goods
        ) VALUES (
            customer_id,
            random_member_level,
            random_member_layer,
            random_points_expire,
            random_collect,
            random_purchase,
            random_cart,
            random_visit,
            random_date,
            DATE_SUB(random_date, INTERVAL FLOOR(1 + RAND() * 30) DAY), -- 首次下单早于最近交易
            DATE_SUB(random_date, INTERVAL FLOOR(1 + RAND() * 30) DAY), -- 店铺首次下单同首次下单
            random_payment_count,
            random_trans_count,
            random_unit_price,
            random_amt,
            random_cycle,
            random_high_potential,
            random_has_purchased
        );

        -- 插入日志
        INSERT INTO data_operation_log (table_name, operation_type, operation_content, log_remark)
        VALUES (
            'customer_store_relation',
            'INSERT',
            JSON_OBJECT(
                'customer_id', customer_id,
                'platform_member_layer', random_member_layer,
                'high_potential_non_purchase', random_high_potential,
                'has_purchased_goods', random_has_purchased
            ),
            CONCAT('新增客户店铺关系数据，客户ID：', customer_id)
        );

        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;

-- 调用存储过程
CALL generate_customer_store_relation(1000);

-- 验证1000条客户数据是否插入成功
SELECT COUNT(*) AS customer_total FROM customer_demographic;

-- 查询最近10条数据操作日志
SELECT id, table_name, operation_type, operation_time, log_remark
FROM data_operation_log
ORDER BY operation_time DESC
LIMIT 10;


-- 关联客户人口属性、店铺关系、全网属性表
SELECT
d.customer_id,
d.predict_age,
d.province,
s.platform_member_layer,
s.high_potential_non_purchase,
a.like_live,
a.leaf_category_comprehensive_prefer
FROM
customer_demographic d
LEFT JOIN
customer_store_relation s ON d.customer_id = s.customer_id
LEFT JOIN
customer_all_network_attr a ON d.customer_id = a.customer_id
LIMIT 10;
